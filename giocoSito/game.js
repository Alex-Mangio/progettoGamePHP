import keyInputs from "./KeyInputs.js";
import Tile, { bushImage } from "./gameMap.js";
import Player from "./player.js";
import Enemy from "./enemy.js";

let ctx;
let canvas;

let canvasH = window.innerHeight;
let canvasW = window.innerWidth;

let gameOver = false;

const player = new Player({
    position: { x: 140, y: 140 },
    velocity: { x: 0, y: 0 }
});

const enemy = new Enemy({
    position: { x: 1610, y: 805 },
    speed: 1.5
});

let map = [];
let inputs = new keyInputs();

window.onload = () => {
    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = false;

    canvas.height = canvasH;
    canvas.width = canvasW;

    bushImage.onload = () => {
        drawMap();

        const waitForImage = setInterval(() => {
            if (player.imageLoad) {
                clearInterval(waitForImage);
                requestAnimationFrame(update);
            }
        }, 100);
    };

    bushImage.src = "./gameImages/cespuglio.png";
};

function update() {
    requestAnimationFrame(update);

    if (gameOver) return;

    movePlayer();

    player.position.x += player.velocity.x;
    player.position.y += player.velocity.y;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    map.forEach((tile) => {
        tile.draw(ctx);
        checkCollision(player, tile);
        checkCollision(enemy, tile);
    });

    enemy.update(map);

    enemy.draw(ctx);
    player.drawPlayer(ctx);

    const eHitbox = enemy.getHitbox();
    const pHitbox = player.getHitbox();

    const collided =
        eHitbox.x < pHitbox.x + pHitbox.width &&
        eHitbox.x + eHitbox.width > pHitbox.x &&
        eHitbox.y < pHitbox.y + pHitbox.height &&
        eHitbox.y + eHitbox.height > pHitbox.y;

    if (collided) {
        console.log("Nemico ha raggiunto il player!");
        gameOver = true;
    }
}

function checkCollision(entity, tile) {
    const eHitbox = entity.getHitbox();
    const tX = tile.position.x;
    const tY = tile.position.y;
    const tW = tile.width;
    const tH = tile.height;

    const collided =
        eHitbox.x < tX + tW &&
        eHitbox.x + eHitbox.width > tX &&
        eHitbox.y < tY + tH &&
        eHitbox.y + eHitbox.height > tY;

    if (collided) {
        const offsetX = eHitbox.x - entity.position.x;
        const offsetY = eHitbox.y - entity.position.y;

        if (entity.velocity.x > 0) {
            entity.position.x = tX - eHitbox.width - offsetX;
            entity.velocity.x = 0;
        } else if (entity.velocity.x < 0) {
            entity.position.x = tX + tW - offsetX;
            entity.velocity.x = 0;
        }

        if (entity.velocity.y > 0) {
            entity.position.y = tY - eHitbox.height - offsetY;
            entity.velocity.y = 0;
        } else if (entity.velocity.y < 0) {
            entity.position.y = tY + tH - offsetY;
            entity.velocity.y = 0;
        }
    }
}

function drawMap(){

    const mapMatrix = [ 
    ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
    ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
    ["0","0","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","-","-","0","0","0","-","-","-","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","-","-","-","0","0","0","-","-","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","-","-","-","-","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","-","-","-","-","-","0","0"],
    ["0","0","-","-","-","-","-","0","0","0","-","0","0","0","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","0","0","0","-","0","0","0","-","-","-","-","-","0","0"],
    ["0","0","-","-","-","-","-","0","0","0","-","0","0","0","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","0","0","0","-","0","0","0","-","-","-","-","-","0","0"],
    ["0","0","-","-","-","-","-","0","0","0","-","0","0","0","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","0","0","0","-","0","0","0","-","-","-","-","-","0","0"],
    ["0","0","-","-","-","-","-","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","-","-","-","-","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","-","-","0","0","0","-","-","-","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","-","-","-","0","0","0","-","-","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","-","-","0","0","0","-","-","0","0","0","0","0","0","0","0","-","0","0","0","0","0","0","0","0","0","0","0","-","0","0"],
    ["0","0","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","-","0","0"],
    ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],
    ["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"]
];

    mapMatrix.forEach((row, i) => {
        row.forEach((symbol, j) => {
            switch(symbol){
                case "-":
                    map.push(
                        new Tile({
                            position: {
                                x:Tile.getWidth() * j,
                                y:Tile.getHeight() * i
                            }
                        })
                    );
                break;
            }
        })
    });

}

function movePlayer() {

    if (gameOver) return;

    const speed = 2;

    player.velocity.x = 0;
    player.velocity.y = 0;

    if (inputs.wPressed) {
        player.velocity.y = -speed;
    } else if (inputs.sPressed) {
        player.velocity.y = speed;
    } else if (inputs.aPressed) {
        player.velocity.x = -speed;
    } else if (inputs.dPressed) {
        player.velocity.x = speed;
    }
}